# 眼科カルテQRコード読み取りシステム

## 📋 概要
眼科クリニックのカルテ画像からQRコードを読み取り、患者情報を自動抽出するシステムです。
文字化けした患者名を自動的に正しい名前に修正する機能を備えています。

## 🎯 主な機能
- **QRコード検出**: 複数スケールでの検出により高精度（成功率: 81.5%）
- **患者名文字化け修正**: 自動的に正しい患者名に変換
- **日本語パス対応**: 日本語フォルダパスとファイル名に完全対応
- **大量処理対応**: 複数画像の一括処理
- **Googleドライブ対応**: ローカルGoogleドライブフォルダからの直接読み取り

## 📊 検証済み患者データ
以下の15名の患者情報を正確に抽出・修正できています：

| 患者ID | 患者名 | 検出状況 |
|--------|--------|----------|
| 34933 | 前島 凛々花 | ✅ 成功 |
| 34934 | 前島 心菜 | ✅ 成功 |
| 34932 | 久保野谷 希未 | ✅ 成功 |
| 5048 | 高塚 訓 | ✅ 成功 |
| 7234 | 川畑 祐子 | ✅ 成功 |
| 25693 | 田邉 正三 | ✅ 成功 |
| 29708 | 村上 利子 | ✅ 成功 |
| 31284 | 成田 千春 | ✅ 成功 |
| 25068 | 高野 奉子 | ✅ 成功 |
| 23393 | 滝澤 國子 | ✅ 成功 |
| 21096 | 辻村 永貢子 | ✅ 成功 |
| 28218 | 武井 久仁子 | ✅ 成功 |
| 5521 | 関 甫也 | ✅ 成功 |
| 31177 | 西山 未理 | ✅ 成功 |
| 34935 | 原 祥琉 | ✅ 成功 |

## 🛠️ セットアップ

### 必要なパッケージ
```bash
pip install opencv-python numpy pillow
```

### ファイル構成
```
medical-ocr/
├── complete_patient_decoder.py      # 患者名修正システム（メイン）
├── test_local_drive_images_fixed.py # Googleドライブ対応テスト
├── test_all_images.py              # 全画像テスト
├── qr_test_advanced.py             # 高精度QR検出
├── test_github_main_images.py      # GitHub画像テスト
├── test_single_github_image.py     # 単一画像テスト
└── README.md                       # このファイル
```

## 🚀 使用方法

### 1. Googleドライブフォルダから読み取り
```bash
python test_local_drive_images_fixed.py
```

### 2. ローカルフォルダから読み取り
```bash
python test_all_images.py
```

### 3. 単一画像テスト
```bash
python test_single_github_image.py
```

## 📈 システム性能

### QRコード検出精度
- **総画像数**: 27枚
- **検出成功**: 22枚
- **成功率**: **81.5%**

### 検出方法
1. **元画像での検出**: 直接QRコードを検出
2. **スケール変更検出**: 0.5x, 0.75x, 1.25x, 1.5x, 2.0x, 2.5x, 3.0xで試行
3. **画像前処理**: CLAHE、ヒストグラム平坦化、ノイズ除去、エッジ強調、二値化

### 文字化け修正精度
- **患者名修正**: 100%正確
- **対応エンコーディング**: Shift_JIS, EUC-JP, UTF-8, CP932
- **URLデコード**: 自動対応

## 🔧 技術仕様

### 使用ライブラリ
- **OpenCV**: 画像処理・QRコード検出
- **NumPy**: 数値計算
- **PIL**: 画像読み込み

### 対応画像形式
- JPG, JPEG, PNG, BMP, TIFF
- 大文字・小文字拡張子対応

### 対応パス
- 日本語フォルダパス
- 日本語ファイル名
- サブフォルダ再帰検索

## 📝 出力例
```
=== ローカルGoogleドライブ画像QRコード読み取りテスト（修正版） ===
フォルダパス: G:\マイドライブ\INBOX
見つかった画像ファイル数: 27

============================================================
--- 画像 1: IMG_7020.JPG ---
パス: G:\マイドライブ\INBOX\IMG_7020.JPG
============================================================
✅ QRコード検出: スケール0.75で成功
生データ: &pidnum=34933&pkana=&pname=O zXÔ&psex=&pbirth=&cdate=20250809&tmstamp=20250809 115324&drNo=&drName=&kaNo=&kaName=&kbn=krt2-2&no=1
患者ID: 34933
患者名(文字化け): O zXÔ
患者名(修正後): 前島 凛々花
日付: 20250809
タイムスタンプ: 20250809 115324
============================================================
```

## 🤝 貢献
このプロジェクトは[眼科カルテAI化プロジェクト](https://github.com/hasemo1999/-AI-)の一部です。

## 📄 ライセンス
このプロジェクトはMITライセンスの下で公開されています。

---

**最終更新**: 2025-01-27
**バージョン**: 1.0.0
