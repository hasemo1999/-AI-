# 眼科カルテAI化プロジェクト

## 📋 プロジェクト概要

眼科クリニックの紙カルテをAI化するプロジェクトです。
100万枚（500GB）のJPEG画像から、眼圧、視力、所見などの医療データを自動抽出します。

## 🎯 対象疾患と重要指標

### 緑内障
- **IOP**（眼圧）
- **RNFL**（網膜神経線維層）
- **MD**（平均偏差）

### 加齢黄斑変性（AMD）
- **CMT**（中心窩網膜厚）
- **滲出**の有無

### 糖尿病網膜症（DMR）
- **血管密度**
- **浮腫**の有無

## 🚀 実装フェーズ

### ✅ P1: 基盤構築（完了）
- QRコード読み取り（実装済み）
- ファイル振り分け（実装済み）
- 重複検知（SHA1）（実装済み）

### ✅ P2: 印刷系OCR（完了）
- NCT平均、レフ（S/C/Ax）、IOLシール
- 目標: 抽出成功 ≥98%

### 🔄 P3: 手書き系OCR（進行中）
- 接触型IOP、視力（裸眼/矯正）
- ROI固定＋正規化
- 目標: 読取精度 ≥95%、qa_flags発生 ≤5%

### ⏳ P4: 眼別判定（未着手）
- OCT/OCTA：ラベルOCRで確定
- Fundus/FAF：乳頭位置ヒューリスティクス

### ⏳ P5: 手術記録（未着手）
- 術前診断・予定術式（5種類辞書＋ファジー）

### ⏳ P6: MA＆ダッシュボード（未着手）
- ma_nouns/key_phrases 付与
- triage一覧、簡易検索

## 📊 データ管理方針

### 構造化データ → CSV
```csv
patient_id,visit_date,exam_type,eye,metric,value,confidence,qa_flag
29708,2025-08-09,NCT,R,IOP,14,0.99,
29708,2025-08-09,NCT,L,IOP,15,0.99,
29708,2025-08-09,REF,R,S,-3.50,0.98,
```

### 非構造化データ → Markdown
```markdown
# 患者ID: 29708 - 村上利子
## 診察日: 2025-08-09

### 所見
- 眼圧安定
- 視野進行なし
- 次回3ヶ月後
```

## 🛠️ 技術スタック

- **データベース**: CSV管理（PostgreSQL不要）
- **OCR**: PaddleOCR（印字モード/手書きモード切り替え）
- **LLM**: Ollama + Llama-3 8B（ローカル）
- **画像AI**: BiomedCLIP
- **ハードウェア**: RTX 4090（または4070）

## 📁 フォルダ構成

```
眼科カルテAI化/
├── Patients/              # 患者データ
│   ├── master.csv        # メインCSV
│   └── [患者ID]/         # 患者別フォルダ
├── p1_*.py              # P1フェーズ実装
├── p3_handwritten_ocr.py # P3フェーズ実装
├── scripts/             # ユーティリティ
└── README.md           # このファイル
```

## 🔧 セットアップ

1. Python 3.11をインストール
2. 依存関係をインストール:
   ```bash
   pip install paddlepaddle paddleocr opencv-python numpy pandas
   ```
3. PaddleOCRの初期化（初回実行時）

## 📝 使用方法

### P3フェーズ（手書き系OCR）の実行
```bash
python p3_handwritten_ocr.py --input path/to/image.jpg --output results.csv
```

### オプション
- `--gpu`: GPU使用
- `--roi`: ROI設定（JSON形式）

## 🎯 現在の課題

### P3フェーズ
- **手書き視力の読み取り精度が低い**
- **矯正視力の識別が困難**
- **ROI設定の最適化が必要**

## 📈 進捗状況

- **P1**: ✅ 完了（QR読取成功 ≥99.5%）
- **P2**: ✅ 完了（印刷系OCR ≥98%）
- **P3**: 🔄 進行中（手書き系OCR 精度調整中）
- **P4-P6**: ⏳ 未着手

## 💡 次のステップ

1. **P3フェーズの精度向上**
   - 手書き視力の正規表現パターン改善
   - ROI設定の最適化
   - 前処理手法の追加

2. **P4フェーズの準備**
   - 眼別判定ロジックの設計
   - ラベルOCRの実装

---

*最終更新: 2025-01-27*
