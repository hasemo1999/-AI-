# 眼科カルテAI化プロジェクトまとめ

## 📋 プロジェクト概要

### 基本情報
- **データ規模**: 100万枚（500GB）のJPEG画像
- **保存場所**: Google Drive（既に保存済み）
- **処理量**: 1日最大180枚（紙カルテ80枚、検査画像100枚）
- **実装期間**: 1ヶ月のゆとりスケジュール

### 技術スタック
- **データベース**: CSV管理（PostgreSQL不要）
- **OCR**: PaddleOCR（印字モード/手書きモード切り替え）
- **LLM**: Ollama + Llama-3 8B（ローカル）
- **画像AI**: BiomedCLIP
- **ハードウェア**: RTX 4090（または4070）

## 🎯 対象疾患と重要指標

### 緑内障
- **IOP**（眼圧）
- **RNFL**（網膜神経線維層）
- **MD**（平均偏差）

### 加齢黄斑変性（AMD）
- **CMT**（中心窩網膜厚）
- **滲出**の有無

### 糖尿病網膜症（DMR）
- **血管密度**
- **浮腫**の有無

## 📊 データ管理方針

### 構造化データ → CSV
```csv
patient_id,visit_date,exam_type,eye,metric,value,confidence,qa_flag
29708,2025-08-09,NCT,R,IOP,14,0.99,
29708,2025-08-09,NCT,L,IOP,15,0.99,
29708,2025-08-09,REF,R,S,-3.50,0.98,
```

### 非構造化データ → Markdown
```markdown
# 患者ID: 29708 - 村上利子
## 診察日: 2025-08-09

### 所見
- 眼圧安定
- 視野進行なし
- 次回3ヶ月後

### メモ
手書き部分のOCR結果をそのまま記載...
```

## 🔄 ワークフロー

### 1. QRコード読み取り
```python
# QRコードから取得できる情報
pidnum: 患者ID（例：29708）
pname: 患者名漢字（例：村上 利子）
cdate: 診察日（例：20250809）
tmstamp: タイムスタンプ
```

### 2. OCR処理（2段階アプローチ）
#### 印字部分（高精度95%以上）
- プリンター出力の眼圧値
- 検査機器のデータ
- ハンコの日付

#### 手書き部分（中精度70-85%）
- 医師の所見
- 手書き視力値
- メモ・コメント

### 3. データ保存
```
Patients/
  29708/
    2025-08-09/
      raw/          # 元画像
      data.csv      # その日の数値
      notes.md      # その日の所見
    2025-05-10/
      ...
    summary.csv     # 全期間の数値統合
```

## 🚀 実装フェーズ

### P1: 基盤構築（必須）
**目標**: QR読取成功 ≥99.5%、重複検知OK、CSVに必須カラム揃う

**タスク**:
- ✅ QRコード読み取り（実装済み）
- ⬜ INBOX → 患者フォルダ振り分け
- ⬜ 縦持ちCSV作成
- ⬜ 重複検知（SHA1）

### P2: 印刷系OCR（機械出力）
**目標**: 
- NCT平均 抽出成功 ≥98%（±1mmHg以内）
- レフ 誤差 ≤±0.25D / 軸 ±5°
- IOLデータ読取 ≥99%

**対象**:
- NCT平均
- レフ（S/C/Ax）
- IOLシール

### P3: 手書き系OCR
**目標**: IOP・視力の読取精度 ≥95%、qa_flags発生 ≤5%

**対象**:
- 接触型IOP
- 視力（裸眼/矯正）
- ROI固定＋正規化

### P4: 眼別判定
**目標**:
- ラベルありの確定率 ≥99%
- Fundus/FAF 推定精度 ≥96%、eye_confidence<0.6 ≤5%

**対象**:
- OCT/OCTA：ラベルOCRで確定
- Fundus/FAF：乳頭位置（＋黄斑・血管）ヒューリスティクス

### P5: 手術記録
**目標**: 術式トップ1一致 ≥98%、不確実は triage に自動回し

**対象**:
- 術前診断・予定術式（5種類辞書＋ファジー）＋眼別付与

### P6: MA＆ダッシュボード
**対象**:
- ma_nouns/key_phrases 付与
- triage一覧
- 簡易検索

## 📝 重要ルール（全フェーズ共通）

1. **失敗管理**: 失敗は必ず `qa_flags` と `*_confidence` を残す（後で一掃できる）
2. **データ保護**: 原本は絶対上書きしない（fileId保持）
3. **段階的実装**: フェーズごとに小さな実データで検収してから次へ

## 💊 薬処方の取得案

### レセコンスクショ方式
**メリット**:
- 正確な薬剤名
- 用法用量も明確
- 印字なのでOCR精度高い

**処理フロー**:
1. レセコン画面をスクショ
2. PaddleOCR（印字モード）で処理
3. 薬剤名・用量をCSVに追記

## 🎯 抽出優先項目

### QRコードから（自動取得）
- 患者ID
- 診察日
- 患者名（漢字）

### OCRから抽出
- 視力データ（VD=, VS=）
- 眼圧（プリンター出力優先）
- 所見・メモ

### 処方薬
- レセコンのスクショから取得予定（未確定）

## 💡 この選択のメリット

- **コスト**: 完全無料
- **複雑さ**: 大幅に簡略化
- **保守性**: CSVなら誰でも修正可能
- **移行性**: 将来DBが必要になっても簡単に移行

## 🔄 次のアクション

1. P1完成のために：
   - `p1_repair_unknown.py` を改良
   - 縦持ちCSV生成部分を追加
   - 10枚でテスト → 99.5%確認

2. PaddleOCRのインストール確認：
   - 「PaddleOCRをインストールして、1枚テストしたい」


# P3フェーズ 統合処理の進捗

## 2024年XX月XX日 更新

### 📊 実装状況
- ✅ P1フェーズ：QRコード読み取り（完了）
- ✅ P2フェーズ：検査データ抽出（完了）
- 🔧 P3フェーズ：視力データ抽出（93%精度達成）

### 🎯 P3フェーズの改善内容
1. **枠内自動検出機能を追加**
   - 処理対象を枠内に限定
   - ノイズ除去で精度向上

2. **パターン認識の強化**
   - IOL記載の検出（100%成功）
   - 矯正度数（S/C/A）の抽出（85%成功）

3. **統合処理の実装**
   - P1+P2+P3の完全統合
   - 患者単位でのデータ管理

### 📈 精度測定結果
| 項目 | 精度 | 目標 |
|------|------|------|
| 視力値 | 100% | 100% |
| IOL検出 | 100% | 95% |
| 度数抽出 | 85% | 90% |
| **総合** | **93%** | **95%** |

### 🔧 残課題
- [ ] 度数パターンの追加調整（残り2%）
- [ ] 全フェーズ統合テスト
- [ ] 本番環境での実行確認

### 📝 テストデータ
- 患者ID：7234, 17784, 25693, 23393
- 各カルテで枠内抽出成功
- 基本視力値は100%認識

*最終更新: ２０２５．８.１２．１４時